name: Move GitHub Project Tasks on Push

on:
  push:
    branches:
      - main
      - TestAutomaticTaskMovement

jobs:
  move_tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Merged PRs
        id: merged_prs
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/EkitaiKani/DOPAssignment/pulls?state=closed&base=main&per_page=5
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Move Tasks to Done
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          for PR in $PR_NUMBERS; do
            ISSUE_NUMBERS=$(gh pr view $PR --json closingIssuesReferences -q '.closingIssuesReferences[].number')
          
            for ISSUE in $ISSUE_NUMBERS; do
              echo "Processing Issue #$ISSUE"
          
              PROJECT_ITEM_ID=$(gh issue view $ISSUE --json projectItems -q '.projectItems[].id')
          
              if [ -z "$PROJECT_ITEM_ID" ]; then
                echo "‚ùå Issue #$ISSUE is NOT linked to a project!"
                continue
              fi
          
              echo "‚úÖ Issue #$ISSUE is linked to Project Item ID: $PROJECT_ITEM_ID"
          
              # Get current column name
              CURRENT_COLUMN=$(gh project item-view --id $PROJECT_ITEM_ID --json column -q '.column.name')
              echo "üîç Issue #$ISSUE is currently in column: $CURRENT_COLUMN"
          
              # Move the issue
              echo "‚û°Ô∏è Moving Issue #$ISSUE to Done..."
              gh project item-update --project "2" --id $PROJECT_ITEM_ID --field "Status" --value "Done"
            done
          done

